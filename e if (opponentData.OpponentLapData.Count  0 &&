[1mdiff --git a/CrewChiefV4/ACS/ACSGameStateMapper.cs b/CrewChiefV4/ACS/ACSGameStateMapper.cs[m
[1mindex ea391e4..62d2acd 100644[m
[1m--- a/CrewChiefV4/ACS/ACSGameStateMapper.cs[m
[1m+++ b/CrewChiefV4/ACS/ACSGameStateMapper.cs[m
[36m@@ -1003,7 +1003,7 @@[m [mnamespace CrewChiefV4.assetto[m
                         if (i != 0 && participantName != null && participantName.Length > 0)[m
                         {[m
                             CarData.CarClass opponentCarClass = CarData.getCarClassForClassName(getNameFromBytes(participantStruct.carModel));[m
[31m-                            addOpponentForName(participantName, createOpponentData(participantStruct, false, opponentCarClass, shared.acsStatic.trackSPlineLength), currentGameState);[m
[32m+[m[32m                            addOpponentForName(participantName, createOpponentData(participantStruct, false, opponentCarClass, shared.acsStatic.trackSPlineLength, false), currentGameState);[m
                         }[m
                     }[m
                 }[m
[36m@@ -1521,7 +1521,7 @@[m [mnamespace CrewChiefV4.assetto[m
                             if (participantStruct.isConnected == 1 && participantName != null && participantName.Length > 0)[m
                             {[m
                                 addOpponentForName(participantName, createOpponentData(participantStruct, true, CarData.getCarClassForClassName(getNameFromBytes(participantStruct.carModel)),[m
[31m-                                    shared.acsStatic.trackSPlineLength), currentGameState);[m
[32m+[m[32m                                    shared.acsStatic.trackSPlineLength, currentGameState.SessionData.SessionType == SessionType.Race), currentGameState);[m
                             }[m
                         }[m
                     }[m
[36m@@ -1965,9 +1965,8 @@[m [mnamespace CrewChiefV4.assetto[m
                     opponentData.CompletedLaps = correctedLapCount;[m
                     // recheck the car class here?[m
                 }[m
[31m-                else if (opponentData.OpponentLapData.Count > 0 &&[m
[31m-                    ((opponentData.CurrentSectorNumber == 1 && sector == 2) || [m
[31m-                     (opponentData.CurrentSectorNumber == 2 && sector == 3)))[m
[32m+[m[32m                else if ((opponentData.CurrentSectorNumber == 1 && sector == 2) ||[m[41m [m
[32m+[m[32m                         (opponentData.CurrentSectorNumber == 2 && sector == 3))[m
                 {[m
                     opponentData.AddCumulativeSectorData(opponentData.CurrentSectorNumber, racePosition, completedLapTime, sessionRunningTime,[m
                         lapIsValid && validSpeed, false, trackTempreture, airTemperature);[m
[36m@@ -1990,13 +1989,15 @@[m [mnamespace CrewChiefV4.assetto[m
             }[m
         }[m
 [m
[31m-        private OpponentData createOpponentData(acsVehicleInfo participantStruct, Boolean loadDriverName, CarData.CarClass carClass, float trackSplineLength)[m
[32m+[m[32m        private OpponentData createOpponentData(acsVehicleInfo participantStruct, Boolean loadDriverName, CarData.CarClass carClass, float trackSplineLength,[m[41m [m
[32m+[m[32m            Boolean raceSessionIsUnderway)[m
         {[m
             OpponentData opponentData = new OpponentData();[m
             String participantName = getNameFromBytes(participantStruct.driverName).ToLower();[m
             opponentData.DriverRawName = participantName;[m
             opponentData.DriverNameSet = true;[m
[31m-            if (participantName != null && participantName.Length > 0 && loadDriverName && CrewChief.enableDriverNames)[m
[32m+[m[32m            // note that in AC, drivers may be added to the session during the race - we don't want to load these driver names[m
[32m+[m[32m            if (participantName != null && participantName.Length > 0 && loadDriverName && CrewChief.enableDriverNames && !raceSessionIsUnderway)[m
             {[m
                 speechRecogniser.addNewOpponentName(opponentData.DriverRawName, "-1");[m
             }[m
[1mdiff --git a/CrewChiefV4/App.config b/CrewChiefV4/App.config[m
[1mindex e63c0d1..3abf993 100644[m
[1m--- a/CrewChiefV4/App.config[m
[1m+++ b/CrewChiefV4/App.config[m
[36m@@ -983,6 +983,15 @@[m
       <setting name="sre_enable_opponents_by_number" serializeAs="String">[m
         <value>False</value>[m
       </setting>[m
[32m+[m[32m      <setting name="naudio_wave_in_sample_rate" serializeAs="String">[m
[32m+[m[32m        <value>8000</value>[m
[32m+[m[32m      </setting>[m
[32m+[m[32m      <setting name="naudio_wave_in_channel_count" serializeAs="String">[m
[32m+[m[32m        <value>1</value>[m
[32m+[m[32m      </setting>[m
[32m+[m[32m      <setting name="naudio_wave_in_sample_depth" serializeAs="String">[m
[32m+[m[32m        <value>16</value>[m
[32m+[m[32m      </setting>[m
     </CrewChiefV4.Properties.Settings>[m
   </userSettings>[m
 </configuration>[m
[1mdiff --git a/CrewChiefV4/Events/PitStops.cs b/CrewChiefV4/Events/PitStops.cs[m
[1mindex 309c3df..6a8648b 100644[m
[1m--- a/CrewChiefV4/Events/PitStops.cs[m
[1m+++ b/CrewChiefV4/Events/PitStops.cs[m
[36m@@ -67,6 +67,7 @@[m [mnamespace CrewChiefV4.Events[m
         private String folderWatchYourPitSpeed = "mandatory_pit_stops/watch_your_pit_speed";[m
         private String folderPitCrewReady = "mandatory_pit_stops/pit_crew_ready";[m
         private String folderPitStallOccupied = "mandatory_pit_stops/pit_stall_occupied";[m
[32m+[m[32m        private String folderPitStallAvailable = "mandatory_pit_stops/pit_stall_available";  // TODO: vocalize[m
         private String folderStopCompleteGo = "mandatory_pit_stops/stop_complete_go";[m
         private String folderPitStopRequestReceived = "mandatory_pit_stops/pit_stop_requested";[m
         private String folderPitStopRequestCancelled = "mandatory_pit_stops/pit_request_cancelled";[m
[36m@@ -904,16 +905,28 @@[m [mnamespace CrewChiefV4.Events[m
                 }[m
             }[m
 [m
[31m-            if (!pitLaneSpeedWarningAnnounced[m
[31m-                && (currentGameState.SessionData.SessionType == SessionType.LonePractice || currentGameState.SessionData.SessionType == SessionType.Practice || currentGameState.SessionData.SessionType == SessionType.Qualify)[m
[31m-                && CrewChief.gameDefinition.gameEnum == GameEnum.RF2_64BIT[m
[31m-                && currentGameState.PitData.InPitlane[m
[31m-                && currentGameState.PositionAndMotionData.CarSpeed > 0.5f)[m
[32m+[m[32m            if (CrewChief.gameDefinition.gameEnum == GameEnum.RF2_64BIT)[m
             {[m
[31m-                pitLaneSpeedWarningAnnounced = true;[m
[31m-                if (currentGameState.PitData.PitSpeedLimit != -1.0f)[m
[32m+[m[32m                if (!pitLaneSpeedWarningAnnounced[m
[32m+[m[32m                    && (currentGameState.SessionData.SessionType == SessionType.LonePractice || currentGameState.SessionData.SessionType == SessionType.Practice || currentGameState.SessionData.SessionType == SessionType.Qualify)[m
[32m+[m[32m                    && currentGameState.PitData.InPitlane[m
[32m+[m[32m                    && currentGameState.PositionAndMotionData.CarSpeed > 0.5f)[m
                 {[m
[31m-                    announcePitlaneSpeedLimit(currentGameState, false /*possiblyAnnounceIntro*/, false /*voiceResponse*/);[m
[32m+[m[32m                    pitLaneSpeedWarningAnnounced = true;[m
[32m+[m[32m                    if (currentGameState.PitData.PitSpeedLimit != -1.0f)[m
[32m+[m[32m                    {[m
[32m+[m[32m                        announcePitlaneSpeedLimit(currentGameState, false /*possiblyAnnounceIntro*/, false /*voiceResponse*/);[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                if (previousGameState != null[m
[32m+[m[32m                    && currentGameState.SessionData.SessionType == SessionType.Race[m
[32m+[m[32m                    && currentGameState.PitData.HasRequestedPitStop)[m
[32m+[m[32m                {[m
[32m+[m[32m                    if (!previousGameState.PitData.PitStallOccupied && currentGameState.PitData.PitStallOccupied)[m
[32m+[m[32m                        audioPlayer.playMessageImmediately(new QueuedMessage(folderPitStallOccupied, 0));[m
[32m+[m[32m                    else if (previousGameState.PitData.PitStallOccupied && !currentGameState.PitData.PitStallOccupied)[m
[32m+[m[32m                        audioPlayer.playMessageImmediately(new QueuedMessage(folderPitStallAvailable, 0));[m
                 }[m
             }[m
         }[m
[1mdiff --git a/CrewChiefV4/GameState/GameStateMapper.cs b/CrewChiefV4/GameState/GameStateMapper.cs[m
[1mindex 4b0706c..fa76b9d 100644[m
[1m--- a/CrewChiefV4/GameState/GameStateMapper.cs[m
[1m+++ b/CrewChiefV4/GameState/GameStateMapper.cs[m
[36m@@ -191,6 +191,8 @@[m [mnamespace CrewChiefV4.GameState[m
                     }[m
                 }[m
             }[m
[32m+[m[32m            // sanity check the leaderLapsCompleted data[m
[32m+[m[32m            leaderLapsCompleted = Math.Max(leaderLapsCompleted, currentGameState.SessionData.CompletedLaps);[m
             if (!currentGameState.SessionData.SessionHasFixedTime)[m
             {[m
                 // work out the laps remaining[m
[1mdiff --git a/CrewChiefV4/Properties/Settings.Designer.cs b/CrewChiefV4/Properties/Settings.Designer.cs[m
[1mindex ea4baa2..278c342 100644[m
[1m--- a/CrewChiefV4/Properties/Settings.Designer.cs[m
[1m+++ b/CrewChiefV4/Properties/Settings.Designer.cs[m
[36m@@ -3838,5 +3838,41 @@[m [mnamespace CrewChiefV4.Properties {[m
                 this["sre_enable_opponents_by_number"] = value;[m
             }[m
         }[m
[32m+[m[41m        [m
[32m+[m[32m        [global::System.Configuration.UserScopedSettingAttribute()][m
[32m+[m[32m        [global::System.Diagnostics.DebuggerNonUserCodeAttribute()][m
[32m+[m[32m        [global::System.Configuration.DefaultSettingValueAttribute("8000")][m
[32m+[m[32m        public int naudio_wave_in_sample_rate {[m
[32m+[m[32m            get {[m
[32m+[m[32m                return ((int)(this["naudio_wave_in_sample_rate"]));[m
[32m+[m[32m            }[m
[32m+[m[32m            set {[m
[32m+[m[32m                this["naudio_wave_in_sample_rate"] = value;[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        [global::System.Configuration.UserScopedSettingAttribute()][m
[32m+[m[32m        [global::System.Diagnostics.DebuggerNonUserCodeAttribute()][m
[32m+[m[32m        [global::System.Configuration.DefaultSettingValueAttribute("1")][m
[32m+[m[32m        public int naudio_wave_in_channel_count {[m
[32m+[m[32m            get {[m
[32m+[m[32m                return ((int)(this["naudio_wave_in_channel_count"]));[m
[32m+[m[32m            }[m
[32m+[m[32m            set {[m
[32m+[m[32m                this["naudio_wave_in_channel_count"] = value;[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[41m        [m
[32m+[m[32m        [global::System.Configuration.UserScopedSettingAttribute()][m
[32m+[m[32m        [global::System.Diagnostics.DebuggerNonUserCodeAttribute()][m
[32m+[m[32m        [global::System.Configuration.DefaultSettingValueAttribute("16")][m
[32m+[m[32m        public int naudio_wave_in_sample_depth {[m
[32m+[m[32m            get {[m
[32m+[m[32m                return ((int)(this["naudio_wave_in_sample_depth"]));[m
[32m+[m[32m            }[m
[32m+[m[32m            set {[m
[32m+[m[32m                this["naudio_wave_in_sample_depth"] = value;[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
     }[m
 }[m
[1mdiff --git a/CrewChiefV4/Properties/Settings.settings b/CrewChiefV4/Properties/Settings.settings[m
[1mindex 756a450..8f21b13 100644[m
[1m--- a/CrewChiefV4/Properties/Settings.settings[m
[1m+++ b/CrewChiefV4/Properties/Settings.settings[m
[36m@@ -956,5 +956,14 @@[m
     <Setting Name="sre_enable_opponents_by_number" Type="System.Boolean" Scope="User">[m
       <Value Profile="(Default)">False</Value>[m
     </Setting>[m
[32m+[m[32m    <Setting Name="naudio_wave_in_sample_rate" Type="System.Int32" Scope="User">[m
[32m+[m[32m      <Value Profile="(Default)">8000</Value>[m
[32m+[m[32m    </Setting>[m
[32m+[m[32m    <Setting Name="naudio_wave_in_channel_count" Type="System.Int32" Scope="User">[m
[32m+[m[32m      <Value Profile="(Default)">1</Value>[m
[32m+[m[32m    </Setting>[m
[32m+[m[32m    <Setting Name="naudio_wave_in_sample_depth" Type="System.Int32" Scope="User">[m
[32m+[m[32m      <Value Profile="(Default)">16</Value>[m
[32m+[m[32m    </Setting>[m
   </Settings>[m
 </SettingsFile>[m
\ No newline at end of file[m
[1mdiff --git a/CrewChiefV4/RF2/RF2GameStateMapper.cs b/CrewChiefV4/RF2/RF2GameStateMapper.cs[m
[1mindex 989de73..a9a5315 100644[m
[1m--- a/CrewChiefV4/RF2/RF2GameStateMapper.cs[m
[1m+++ b/CrewChiefV4/RF2/RF2GameStateMapper.cs[m
[36m@@ -150,6 +150,9 @@[m [mnamespace CrewChiefV4.rFactor2[m
             if (RF2GameStateMapper.pluginVerified)[m
                 return;[m
 [m
[32m+[m[32m            // Only verify once.[m
[32m+[m[32m            RF2GameStateMapper.pluginVerified = true;[m
[32m+[m
             var shared = memoryMappedFileStruct as CrewChiefV4.rFactor2.RF2SharedMemoryReader.RF2StructWrapper;[m
             var versionStr = RF2GameStateMapper.GetStringFromBytes(shared.extended.mVersion);[m
 [m
[36m@@ -196,9 +199,6 @@[m [mnamespace CrewChiefV4.rFactor2[m
                     + (shared.extended.mDirectMemoryAccessEnabled != 0 ? "  DMA enabled." : "");[m
                 Console.WriteLine(msg);[m
             }[m
[31m-[m
[31m-            // Only verify once.[m
[31m-            RF2GameStateMapper.pluginVerified = true;[m
         }[m
         [m
         // Abrupt session detection variables.[m
[36m@@ -1611,6 +1611,17 @@[m [mnamespace CrewChiefV4.rFactor2[m
                 // shouldn't have duplicates, but just in case[m
                 if (!cgs.OpponentData.ContainsKey(opponentKey))[m
                     cgs.OpponentData.Add(opponentKey, opponent);[m
[32m+[m
[32m+[m[32m                if (cgs.PitData.HasRequestedPitStop[m
[32m+[m[32m                    && csd.SessionType == SessionType.Race)[m
[32m+[m[32m                {[m
[32m+[m[32m                    // Detect if opponent occupies player's stall.[m
[32m+[m[32m                    if (vehicleScoring.mPitState == (byte)rFactor2Constants.rF2PitState.Stopped)[m
[32m+[m[32m                    {[m
[32m+[m[32m                        if (Math.Abs(cgs.PitData.PitBoxPositionEstimate - opponent.DistanceRoundTrack) < 5.0)[m
[32m+[m[32m                            cgs.PitData.PitStallOccupied = true;[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
             }[m
 [m
             cgs.sortClassPositions();[m
[36m@@ -2569,7 +2580,7 @@[m [mnamespace CrewChiefV4.rFactor2[m
                 else[m
                     tyreType = TyreType.Soft;[m
             }[m
[31m-            else if (frontCompound.Contains("WET"))[m
[32m+[m[32m            else if (frontCompound.Contains("WET") || frontCompound.Contains("RAIN"))[m
                 tyreType = TyreType.Wet;[m
             else if (frontCompound.Contains("INTERMEDIATE"))[m
                 tyreType = TyreType.Intermediate;[m
[1mdiff --git a/CrewChiefV4/SpeechRecogniser.cs b/CrewChiefV4/SpeechRecogniser.cs[m
[1mindex 9e60a4f..10c2251 100644[m
[1m--- a/CrewChiefV4/SpeechRecogniser.cs[m
[1m+++ b/CrewChiefV4/SpeechRecogniser.cs[m
[36m@@ -17,6 +17,10 @@[m [mnamespace CrewChiefV4[m
     {[m
         private SpeechRecognitionEngine sre;[m
 [m
[32m+[m[32m        private int nAudioWaveInSampleRate = UserSettings.GetUserSettings().getInt("naudio_wave_in_sample_rate");[m
[32m+[m[32m        private int nAudioWaveInChannelCount = UserSettings.GetUserSettings().getInt("naudio_wave_in_channel_count");[m
[32m+[m[32m        private int nAudioWaveInSampleDepth = UserSettings.GetUserSettings().getInt("naudio_wave_in_sample_depth");[m
[32m+[m
         private Boolean identifyOpponentsByPosition = UserSettings.GetUserSettings().getBoolean("sre_enable_opponents_by_position");[m
         private Boolean identifyOpponentsByName = UserSettings.GetUserSettings().getBoolean("sre_enable_opponents_by_name");[m
         private Boolean identifyOpponentsByNumber = UserSettings.GetUserSettings().getBoolean("sre_enable_opponents_by_number");[m
[36m@@ -805,7 +809,7 @@[m [mnamespace CrewChiefV4[m
             {[m
                 if (useNAudio)[m
                 {[m
[31m-                    waveIn.WaveFormat = new NAudio.Wave.WaveFormat(8000, 1);[m
[32m+[m[32m                    waveIn.WaveFormat = new NAudio.Wave.WaveFormat(nAudioWaveInSampleRate, nAudioWaveInChannelCount);[m
                     waveIn.DataAvailable += new EventHandler<NAudio.Wave.WaveInEventArgs>(waveIn_DataAvailable);[m
                     waveIn.NumberOfBuffers = 3;[m
                 }[m
[36m@@ -1709,7 +1713,9 @@[m [mnamespace CrewChiefV4[m
                                 }[m
                                 Microsoft.Speech.AudioFormat.SpeechAudioFormatInfo safi =[m
                                     new Microsoft.Speech.AudioFormat.SpeechAudioFormatInfo([m
[31m-                                        waveIn.WaveFormat.SampleRate, Microsoft.Speech.AudioFormat.AudioBitsPerSample.Sixteen, Microsoft.Speech.AudioFormat.AudioChannel.Mono);[m
[32m+[m[32m                                        nAudioWaveInSampleRate,[m
[32m+[m[32m                                        nAudioWaveInSampleDepth == 16 ? Microsoft.Speech.AudioFormat.AudioBitsPerSample.Sixteen : Microsoft.Speech.AudioFormat.AudioBitsPerSample.Eight,[m[41m [m
[32m+[m[32m                                        nAudioWaveInChannelCount == 2 ? Microsoft.Speech.AudioFormat.AudioChannel.Stereo : Microsoft.Speech.AudioFormat.AudioChannel.Mono);[m
                                 sre.SetInputToAudioStream(buffer, safi); // otherwise input gets unset[m
                                 try[m
                                 {[m
[1mdiff --git a/CrewChiefV4/TrackData.cs b/CrewChiefV4/TrackData.cs[m
[1mindex d36e7f6..7286436 100644[m
[1m--- a/CrewChiefV4/TrackData.cs[m
[1m+++ b/CrewChiefV4/TrackData.cs[m
[36m@@ -920,7 +920,12 @@[m [mnamespace CrewChiefV4[m
 [m
         public void setGapPoints()[m
         {[m
[31m-            if (trackLength > TrackData.gapPointsThreshold)[m
[32m+[m[32m            // special case for 2 sector tracks[m
[32m+[m[32m            if (sectorsOnTrack == 2)[m
[32m+[m[32m            {[m
[32m+[m[32m                gapPoints = new float[] {(float)Math.Round(trackLength / 2f), trackLength - 50};[m
[32m+[m[32m            }[m
[32m+[m[32m            else if (trackLength > TrackData.gapPointsThreshold)[m
             {[m
                 float totalGaps = 0;[m
                 List<float> gaps = new List<float>();[m
[1mdiff --git a/CrewChiefV4/Validator.cs b/CrewChiefV4/Validator.cs[m
[1mindex c4addf6..28e151f 100644[m
[1m--- a/CrewChiefV4/Validator.cs[m
[1m+++ b/CrewChiefV4/Validator.cs[m
[36m@@ -16,7 +16,7 @@[m [mnamespace CrewChiefV4[m
              "paul hance", "aline senna", "giuseppe sangalli", "patrick förster", "chris iwaski", "gazman", "peter koch",[m
              "andreas christiansen", "greg metcalf", "Aditas H1Z1Cases.com.", /* TODO: remove bruno in a future update */"Bruno Bæ",[m
              "maciej bugno", "patrick schilhan" /*as reward for your "make r3e app free" campaign.*/,[m
[31m-             "tim heinemann", "Josh Cassar", "Jesse Hoppo", "markus grönthal" };[m
[32m+[m[32m             "tim heinemann", "Josh Cassar", "Jesse Hoppo", "markus grönthal", "joan moreno" };[m
  [m
           public static void validate(String str)[m
           {[m
[1mdiff --git a/CrewChiefV4/ui_text.txt b/CrewChiefV4/ui_text.txt[m
[1mindex dfddbb4..76a5143 100644[m
[1m--- a/CrewChiefV4/ui_text.txt[m
[1m+++ b/CrewChiefV4/ui_text.txt[m
[36m@@ -1335,4 +1335,16 @@[m [msre_enable_opponents_by_number_category = AUDIO_VOICE_AND_CONTROLLERS[m
 [m
 sre_enable_opponents_by_name = Identify opponents by driver name[m
 sre_enable_opponents_by_name_help = Allow the app to recognise opponents in voice commands by their driver name[m
[31m-sre_enable_opponents_by_name_category = AUDIO_VOICE_AND_CONTROLLERS[m
\ No newline at end of file[m
[32m+[m[32msre_enable_opponents_by_name_category = AUDIO_VOICE_AND_CONTROLLERS[m
[32m+[m
[32m+[m[32mnaudio_wave_in_sample_rate = Sample rate for nAudio wave-in device[m
[32m+[m[32mnaudio_wave_in_sample_rate_help = Sample rate for voice recording device (Hz, nAudio only)[m
[32m+[m[32mnaudio_wave_in_sample_rate_category = AUDIO_VOICE_AND_CONTROLLERS[m
[32m+[m
[32m+[m[32mnaudio_wave_in_channel_count = Channel count for nAudio wave-in device[m
[32m+[m[32mnaudio_wave_in_channel_count_help = Channels (1: mono, 2: stereo) for recording device (nAudio only)[m
[32m+[m[32mnaudio_wave_in_channel_count_category = AUDIO_VOICE_AND_CONTROLLERS[m
[32m+[m
[32m+[m[32mnaudio_wave_in_sample_depth = Sample depth for nAudio wave-in device (8 or 16)[m
[32m+[m[32mnaudio_wave_in_sample_depth_help = Sample depth, 8 or 16 bits per sample, for recording device (nAudio only)[m
[32m+[m[32mnaudio_wave_in_sample_depth_category = AUDIO_VOICE_AND_CONTROLLERS[m
\ No newline at end of file[m
